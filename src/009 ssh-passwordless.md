[Я не туда нажал и хочу обратно в оглавление](./000%20toc.md)

# Настройка ssh аутентификации при помощи публичного ключа
Этот вариант аутентификации для ssh является еще более безопасным, чем просто использование ssh с именем пользователя и паролем.
## Предварительные условия
1. Настроена и запущена виртуальная машина с Ubuntu.
2. Для виртуальной машины настроено Bridged сетевое соединение.
3. На виртуальной машине установлен и работает ssh сервер.
4. Вы можете войти по ssh с локальной Windows (на самом деле уже неважно) машины на виртуальную машину с Ubuntu.

## Генерируем ключи в git bash
1. Запускаем git bash
2. Проверяем, нет ли у нас случайно уже сгенерированных ключей (например, вы купили краденный ноут и не переустанавливали систему):

```ls -l ~/.ssh```
Такой вывод результатов команды говорит нам о том, что ключей у нас нет:

![NoNothing](./img/009%20RsaNoKeys.png)

Такой означает, что ключи все же есть (вам лучше знать, откуда они):
![NotNoNothing](./img/009%20RsaThereAreSomeKeys.png)

3. Всё же генерируем ключи

> Сразу договоримся: *"your_email@example.com"* — это ваш настоящий адрес электронной почты, т.е. эту строку нужно заменить при выполнении команды! Я предупредил.

```ssh-keygen -t rsa -b 4096 -C "your_email@example.com" ```

Генератор спросит нас, куда бы нам записать эти ключи. Используем папку, которую он хочет по умолчанию:

![Accept path](./img/009%20RsaAcceptDir.png)

4. Генератор спросит вас, какой пароль использовать для шифрования секретного ключа. Этот пароль будет необходимо вводить каждый раз, когда вам нужно будет этот ключ использовать. 
> Для тестовых целей можно этот пароль не вводить и просто два раза нажать Enter, потом этот пароль можно будет задать, если вы планируете этот ключ использовать и заботитесь о безопасности. Это важно. :point_up: 

Вот это окно означает, что пара ключей секретный (private) и публичный (public) были успешно для вас сгенерированы.

![Keys are generated](./img/009%20RsaYesYesYes.png)

Ок!

4. добавляем ключи ssh агенту

>Чтобы этими ключами пользоваться при работе, необходимо, чтобы ssh агент на нашей стороне знал о них.

всё в том же окне git bash:

```ssh-add ~/.ssh/id_rsa```

Агент добавит себе этот ключ и будет с ним работать.

#### лирическое отступление

>**~** в этих ваших линуксах означает домашнюю директорию пользователя.
>
>В Windows это будет что-то вроде ```C:\Users\%username%\```, если вам придет в голову искать это. 

Попасть в ту же самую папку ~, на которую ссылается git bash можно вот так:

![picture](./img/009%20RsaWinHome.png)

Да, да, да. Прямо в проводнике вводим ```%HOMEPATH%``` нажимаем Enter и попадаем в ```C:\Users\%username%\```. Профит!

5. Проверяем, жив ли ssh агент

там же, в git bash:

```eval "$(ssh-agent -s)"```

Если все хорошо, то это будет выглядеть так:

![picture](./img/009%20RsaAgentIsAlive.png)

Зачем мы это все делали?

### git bash аутентификация при помощи ключа
Чтобы удаленная машина признала нас за хозяина, ей нужно как-то сообщить **публичный (открытый) ключ**.

Для того, чтобы передать на удаленную машину наш открытый ключ, необходимо в git bash выполнить команду:

```ssh-copy-id user@192.168.1.xxx```

В окне вы увидите, какой ключ мы пытаемся передать. Для того, чтобы данные о ключе были переданы, необходимо ввести пароль удаленной машины.

>Забыл сказать: пароли в терминалах не отображаются. Вообще. Ни буквы, ни значки типа *, просто темнота и всё.

![ssh-copy-id](./img/009%20SshCopyIdInstalled.png)

Теперь можно попробовать войти на удаленную машину при помощи ключа. 

В git bash:

```ssh user@192.168.1.xxx```

Так как на предыдущих шагах для секретного ключа я не задал пароль, то я просто попадаю на удаленную машину:

![ssh-copy-id](./img/009%20SshSuccessfulLoginwithKey.png)

### Putty аутентификация при помощи ключа

Так как публичный (или открытый) ключ уже на удаленной машине, то больше ничего не нужно делать, но...

1. У Putty немного другой формат хранения секретного ключа, поэтому нам будет необходимо его сначала конфвертировать в путтин формат.
2. Конвертация происходит в приложении, которое входит в состав дистрибутива Putty и называется Putty Gen. Запускаем его.

![Run Putty Gen, run!](./img/009%20SshPuttyImportSecretKeyRunGen.png)

3. Появится одинокое пустое окно, где нам нужно нажать на кнопку **Load**
4. В окне выбора файла нужно установить просмотр всех файлов, а не только путтиных. И выбрать наш *сикретный* файл, который мы сгенерировали при помощи git bash.

![get secret file](./img/009%20SsahImportRsaSecretToPutty.png)

5. Putty gen скажет, что импорт-то, конечно ок, но нужно сохранить в моем формате. Иного выхода у нас нет.

![Run Putty Gen, run!](./img/009%20SshPuttyGenSaveToPuttyFromat.png)

6. Чтобы потом не запутаться в папках, я предлагаю всю эту радость сохранять всё там же, где git bash хранит свои ключи. Жмём **Save private key**.

![Run Putty Gen, run!](./img/009%20SshPuttyGenSavePrivateKey.png)

7. Опять же, для тестовых целей и домашнего использования можно не задавать пароль для секретного ключа, если планируете использовать удаленный VPS, то пароль лучше всего для ключа задать.

![Run Putty Gen, run!](./img/009%20SshPuttyGenSavePrivateKeyFile.png)

8. Добавляем секретный ключ в наш конфиг.
   1. Запускаем Putty
   2. Загружаем нашу конфигурацию для Ubuntu (**Load**)
   3. Переходим в дереве настроек SSH > Auth
   4. Добавляем путь к секретному файлу в формате Putty
    
    ![Add key to Putty cfg](./img/009%20SshPuttyAddPrivateKeyPath.png)
   
   5. Переходим в Session и сохраняем параметры сессии
   6. Жмём в конце-концов **Open**

     ![Add key to Putty cfg](./img/009%20SshPuttyComplete.png)

Всё, мы прошли аутентификацию с ключом.

Далее начинаем устанавливать то, что будет работать на тестовом стенде.

- [x] [Создадим виртуальную машину.](005%20vm%20and%20ubuntu.md)
- [x] [Установим на нее Ubuntu.](005%20vm%20and%20ubuntu.md)
- [x] [Проверим, что все установилось.](006%20checkWeAreOkay.md) 
- [x] [Да! Еще выучим пару команд линуха.](006%20checkWeAreOkay.md)
- [x] [Настроим ssh на локальной Windows машине.](007%20sshLocalWindows.md)
- [x] [Настроим ssh сервер на Ubuntu.](008%20sshOnVm.md)
- [x] [Настроим аутентификацию при помощи публичного ключа на Ubuntu.](009%20ssh-passwordless.md)
- [x] [Начнем работать с Ubuntu только через терминал.](009%20ssh-passwordless.md)  :point_left: You are here.
- [ ] [Установим JDK.](010%20InstallJDK.md)
- [ ] Установим SDK.
- [ ] Установим Gradle.
- [ ] Установим Jenkins.
- [ ] Установим Docker.
- [ ] Установим Selenoid.

[Оглавление](./000%20toc.md)